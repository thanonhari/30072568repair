<!-- from line richmenu 
Endpoint_URL:https://thanonhari.github.io/30072568repair/
LIFF_URL:https://liff.line.me/2007495650-QbyzOvv8 
const LIFF_ID = "2007495650-QbyzOvv8"; 
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFrASmRlRDtOaAH2oHIs-wgBfUUlO2X_Gg3IQ5dTg0KMqIjN-tP5zqSRDGomqW7UPn/exec"; 
‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 14/08/2568 App ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 11/082568 save from on to TRUE from line liff-->

<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #f5f5f5;
    }

    .hidden {
      display: none;
    }

    /* Loading Spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #15803d;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      margin-top: 16px;
      color: #15803d;
      font-weight: 500;
    }
  </style>
</head>

<body class="bg-gray-50">
  <div id="app-container" class="min-h-screen flex flex-col">
    <header class="bg-green-800 text-white shadow-md">
      <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <h1 class="text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>
        <div id="userMenu" class="relative">
          <button onclick="document.getElementById('userMenuDropdown').classList.toggle('hidden')"
            class="flex items-center space-x-2">
            <img id="userProfilePic" class="w-8 h-8 rounded-full bg-yellow-400">
            <span id="userDisplayName" class="text-sm font-medium">Loading...</span>
          </button>
          <div id="userMenuDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden">
            <a href="#" onclick="if(liff.isLoggedIn()) { liff.logout(); } liff.closeWindow();"
              class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
      <div id="repairContent" class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-green-800 mb-4">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>
        <form id="repairForm">
          <input type="hidden" id="lineUserId" name="lineUserId">
          <input type="hidden" id="lineDisplayName" name="lineDisplayName">
          <input type="hidden" id="linePictureUrl" name="linePictureUrl">
          <input type="hidden" id="userEmail" name="userEmail">
          <input type="hidden" id="uuid" name="uuid">
          <input type="hidden" id="ticketId" name="ticketId">
          <input type="hidden" id="repairDate" name="repairDate">
          <input type="hidden" id="repairTime" name="repairTime">

          <div class="space-y-6">
            <div>
              <h3 class="text-md font-medium text-gray-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (‡∏à‡∏≤‡∏Å LINE)</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-gray-100 rounded-md">
                <div><label for="userName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span
                      class="text-red-500">*</span></label><input type="text" id="userName" name="userName"
                    class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div>
                  <label for="displayUserEmail" class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏• <span
                      class="text-gray-400">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span></label>
                  <input type="email" id="displayUserEmail"
                    class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                  <!-- Email Warning Message -->
                  <div id="emailWarning" class="hidden mt-2 p-2 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <p class="text-xs text-yellow-700">
                      <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ú‡∏π‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-md font-medium text-gray-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="userPosition" class="block text-sm font-medium text-gray-700">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á <span
                      class="text-red-500">*</span></label><input type="text" id="userPosition" name="userPosition"
                    class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="userDepartment" class="block text-sm font-medium text-gray-700">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô <span
                      class="text-red-500">*</span></label><input type="text" id="userDepartment" name="userDepartment"
                    class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="userPhone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <span
                      class="text-red-500">*</span></label><input type="text" id="userPhone" name="userPhone"
                    maxlength="4" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="userLocation" class="block text-sm font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á <span
                      class="text-red-500">*</span></label><input type="text" id="userLocation" name="userLocation"
                    class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></div>
              </div>
            </div>

            <div>
              <h3 class="text-md font-medium text-gray-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</h3>
              <div class="space-y-4">
                <div><label for="equipmentHistory"
                    class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><select
                    id="equipmentHistory" name="equipmentHistory"
                    class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" disabled>
                    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                  </select></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div><label for="equipmentName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå <span
                        class="text-red-500">*</span></label><input type="text" id="equipmentName" name="equipmentName"
                      class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></div>
                  <div><label for="equipmentId" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå <span
                        class="text-red-500">*</span></label><input type="text" id="equipmentId" name="equipmentId"
                      class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></div>
                </div>
              </div>
            </div>

            <div><label for="problemDesc" class="block text-sm font-medium text-gray-700">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢ <span
                  class="text-red-500">*</span></label><textarea id="problemDesc" name="problemDesc" rows="4"
                class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></textarea></div>
            <div><label class="block text-sm font-medium text-gray-700">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="file"
                id="imageUpload" name="imageUpload" accept="image/*"
                class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"><img
                id="imagePreview" class="hidden mt-2 max-h-40 border p-1 rounded" src="#" alt="Preview"></div>
          </div>

          <div class="mt-6 border-t pt-4">
            <label class="flex items-center"><input type="checkbox" id="pdpaConsent" name="pdpaConsent" required
                class="h-5 w-5 text-green-700 focus:ring-green-500 border-gray-300 rounded"><span
                class="ml-2 text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
                <span class="text-red-500">*</span></span></label>
          </div>

          <div class="flex justify-center gap-4 mt-8">
            <button type="button" id="cancelButton" onclick="cancelForm()"
              class="bg-gray-500 hover:bg-gray-700 text-white font-medium py-2 px-6 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" id="submitButton"
              class="bg-green-700 hover:bg-green-900 text-white font-medium py-2 px-6 rounded-md disabled:bg-gray-400 disabled:cursor-not-allowed">‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
          </div>
        </form>
      </div>

      <!-- Loading Overlay with Spinner -->
      <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loadingText" class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
      </div>
    </main>
  </div>

  <script>
    const LIFF_ID = "2007495650-QbyzOvv8";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby02fO2_GgLEWJif2dYzF9wKK1f9SDiRxXGPuCshwIdwx-e4MZj2227RZ8-fSJCZm46GQ/exec";

    // ============ DEBUG MODE ============
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö local ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ LINE
    const DEBUG_MODE = false;  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö local

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• mock ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    const MOCK_PROFILE = {
      userId: "U1234567890abcdef",
      displayName: "‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö",
      pictureUrl: "https://via.placeholder.com/150",
      email: "test@example.com"
    };
    // ====================================

    let imageBase64 = "", imageFileName = "", imageMimeType = "";

    function generateUUID() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = (Math.random() * 16) | 0, v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    }
    function generateTicketID() {
      const d = new Date();
      return `REP${d.getFullYear().toString().slice(-2)}${String(d.getMonth() + 1).padStart(2, "0")}${String(d.getDate()).padStart(2, "0")}-${Math.floor(Math.random() * 10000).toString().padStart(4, "0")}`;
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÅ‡∏ö‡∏ö GET ‡∏û‡∏£‡πâ‡∏≠‡∏° error handling
    async function fetchFromApi(action, params = {}) {
      const url = new URL(SCRIPT_URL);
      url.searchParams.append('action', action);
      for (const k in params) url.searchParams.append(k, params[k]);

      const res = await fetch(url);
      if (!res.ok) throw new Error(`API '${action}' status ${res.status}`);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      return data;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');

      // Helper functions for loading state
      function showLoading(message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
        loadingText.textContent = message;
        loadingOverlay.classList.remove('hidden');
      }
      function hideLoading() {
        loadingOverlay.classList.add('hidden');
      }

      try {
        let profile, userEmail;

        // ============ DEBUG MODE HANDLING ============
        if (DEBUG_MODE) {
          console.log('üîß DEBUG MODE: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• mock ‡πÅ‡∏ó‡∏ô LINE LIFF');
          profile = MOCK_PROFILE;
          userEmail = MOCK_PROFILE.email;
        } else {
          // ============ PRODUCTION MODE ============
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: window.location.href });
            return;
          }

          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE...');
          profile = await liff.getProfile();
          const decodedToken = await liff.getDecodedIDToken();
          userEmail = decodedToken?.email || '';  // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ email

          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ email ‡πÅ‡∏™‡∏î‡∏á warning ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
          if (!userEmail) {
            document.getElementById('emailWarning').classList.remove('hidden');
            console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö email ‡∏à‡∏≤‡∏Å LINE profile');
          }
        }
        // =============================================

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LINE Profile
        document.getElementById('lineUserId').value = profile.userId;
        document.getElementById('lineDisplayName').value = profile.displayName;
        document.getElementById('linePictureUrl').value = profile.pictureUrl || '';
        document.getElementById('userName').value = profile.displayName;
        document.getElementById('userEmail').value = userEmail;
        document.getElementById('displayUserEmail').value = userEmail;
        document.getElementById('userDisplayName').textContent = profile.displayName;
        if (profile.pictureUrl) document.getElementById('userProfilePic').src = profile.pictureUrl;

        document.getElementById('uuid').value = generateUUID();
        document.getElementById('ticketId').value = generateTicketID();

        const now = new Date();
        document.getElementById('repairDate').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
        document.getElementById('repairTime').value = `${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;

        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å backend (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ email)
        if (userEmail) {
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...');
          try {
            const userDetails = await fetchFromApi('getUserByEmail', { email: userEmail });

            if (userDetails && Object.keys(userDetails).length > 0) {
              if (userDetails.name) document.getElementById('userName').value = userDetails.name;
              document.getElementById('userPosition').value = userDetails.position || '';
              document.getElementById('userDepartment').value = userDetails.department || '';
              document.getElementById('userPhone').value = userDetails.phone || '';
              document.getElementById('userLocation').value = userDetails.location || '';
              if (userDetails.uuid) document.getElementById('uuid').value = userDetails.uuid;
            }
          } catch (e) {
            console.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:', e.message);
          }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ email)
        const equipmentSelect = document.getElementById('equipmentHistory');
        if (userEmail) {
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°...');
          try {
            const equipmentHistory = await fetchFromApi('getEquipmentHistoryForUser', { email: userEmail });

            if (equipmentHistory && equipmentHistory.length > 0) {
              equipmentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ --</option>';
              equipmentHistory.forEach(eq => equipmentSelect.add(new Option(`${eq.name} (${eq.id})`, JSON.stringify(eq))));
              equipmentSelect.disabled = false;
            } else {
              equipmentSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</option>';
            }
          } catch (e) {
            console.log('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå:', e.message);
            equipmentSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</option>';
          }
        } else {
          equipmentSelect.innerHTML = '<option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</option>';
        }

        hideLoading();

      } catch (err) {
        console.error("Initialization Error:", err);
        hideLoading();
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${err.message}` });
      }
    });

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    document.getElementById('imageUpload').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById('imagePreview').src = e.target.result;
        document.getElementById('imagePreview').classList.remove('hidden');
        imageBase64 = e.target.result.split(',')[1];
      };
      reader.readAsDataURL(file);
      imageFileName = file.name;
      imageMimeType = file.type;
    });

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå
    document.getElementById('equipmentHistory').addEventListener('change', (e) => {
      if (!e.target.value) return;
      const eq = JSON.parse(e.target.value);
      document.getElementById('equipmentName').value = eq.name || '';
      document.getElementById('equipmentId').value = eq.id || '';
    });

    // Sync email ‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á hidden field
    document.getElementById('displayUserEmail').addEventListener('input', (e) => {
      document.getElementById('userEmail').value = e.target.value;
    });

    // ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
    document.getElementById('repairForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // ‚ö†Ô∏è ‡∏´‡∏¢‡∏¥‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô scope ‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏Å‡∏±‡∏ô ReferenceError)
      const submitButton = document.getElementById('submitButton');
      if (submitButton.disabled) return;

      if (!document.getElementById('pdpaConsent').checked) {
        Swal.fire({ icon: "warning", title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç", text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ø ‡∏Å‡πà‡∏≠‡∏ô" });
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö email (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô)
      const emailValue = document.getElementById('displayUserEmail').value.trim();
      if (!emailValue) {
        Swal.fire({
          icon: "warning",
          title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
          html: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°<br><small class='text-gray-500'>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ú‡∏π‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡∏±‡∏ö LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</small>"
        });
        document.getElementById('displayUserEmail').focus();
        return;
      }
      // Sync email to hidden field
      document.getElementById('userEmail').value = emailValue;

      submitButton.disabled = true;
      Swal.fire({ title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°
      const formDataObject = {
        lineUserId: document.getElementById('lineUserId').value,
        lineDisplayName: document.getElementById('lineDisplayName').value,
        linePictureUrl: document.getElementById('linePictureUrl').value,
        userEmail: document.getElementById('userEmail').value,
        uuid: document.getElementById('uuid').value,
        ticketId: document.getElementById('ticketId').value,
        repairDate: document.getElementById('repairDate').value,
        repairTime: document.getElementById('repairTime').value,
        userName: document.getElementById('userName').value,
        userPosition: document.getElementById('userPosition').value,
        userDepartment: document.getElementById('userDepartment').value,
        userPhone: document.getElementById('userPhone').value,
        userLocation: document.getElementById('userLocation').value,
        equipmentName: document.getElementById('equipmentName').value,
        equipmentId: document.getElementById('equipmentId').value,
        problemDesc: document.getElementById('problemDesc').value,
        pdpaConsent: document.getElementById('pdpaConsent').checked,
        role: 'User'
      };
      if (imageBase64) {
        formDataObject.imageBase64 = imageBase64;
        formDataObject.imageName = imageFileName;
        formDataObject.imageMimeType = imageMimeType;
      }

      // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö URLSearchParams + action=submitRepair
      const params = new URLSearchParams();
      params.append('action', 'submitRepair'); // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
      for (const key in formDataObject) params.append(key, formDataObject[key]);

      try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const result = await response.json();

        if (result.result === 'success') {
          await Swal.fire({ icon: 'success', title: '‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' });

          // Reset form ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          document.getElementById('repairForm').reset();
          // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
          imageBase64 = '';
          imageFileName = '';
          imageMimeType = '';
          document.getElementById('imagePreview').classList.add('hidden');
          document.getElementById('imagePreview').src = '#';
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà
          document.getElementById('uuid').value = generateUUID();
          document.getElementById('ticketId').value = generateTicketID();
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
          const now = new Date();
          document.getElementById('repairDate').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
          document.getElementById('repairTime').value = `${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;

          // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô LINE (DEBUG_MODE ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î)
          if (!DEBUG_MODE && typeof liff !== 'undefined' && liff.isInClient()) {
            liff.closeWindow();
          }
        } else {
          throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: error.message });
      } finally {
        submitButton.disabled = false;
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    async function testConnection() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=test`);
        const data = await res.json();
        alert("Connection Test Result: " + data.message);
      } catch (err) {
        console.error("Test Failed:", err);
        alert("Connection Test FAILED. ‡∏î‡∏π console ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°");
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
    function cancelForm() {
      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?',
        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        cancelButtonText: '‡πÑ‡∏°‡πà, ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å'
      }).then((result) => {
        if (result.isConfirmed) {
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
          document.getElementById('repairForm').reset();
          // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
          imageBase64 = '';
          imageFileName = '';
          imageMimeType = '';
          document.getElementById('imagePreview').classList.add('hidden');
          document.getElementById('imagePreview').src = '#';

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà
          document.getElementById('uuid').value = generateUUID();
          document.getElementById('ticketId').value = generateTicketID();

          Swal.fire({
            icon: 'info',
            title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß',
            text: '‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
            timer: 1500,
            showConfirmButton: false
          });

          // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô LINE ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
          if (typeof liff !== 'undefined' && !DEBUG_MODE && liff.isInClient()) {
            liff.closeWindow();
          }
        }
      });
    }
  </script>

</body>

</html>
